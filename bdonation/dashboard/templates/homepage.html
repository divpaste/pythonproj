{% load static %}
<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="{% static 'homepage.css' %}">
</head>

{% load static %}
<!DOCTYPE html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="{% static 'homepage.css' %}">
</head>

<body>
    <nav id="navbar">
        <div id="logoname">
            <h2>BloodConnect</h2>
        </div>

        <div id="userlogout">
            {% if request.user.is_authenticated %}
            <p>
                Hello, {{ request.user }}
            </p>
            <a id="logoutbtn"
                href="{% if user.role == 'D' %}{% url 'inbox' %}{% elif user.role == 'R' %}{% url 'receiver_inbox' %}{% endif %}"
                class="navlink">
                INBOX
            </a>
            <a id="logoutbtn" href="{% url 'logout' %}">LOGOUT</a>
            {% else %}
            <p>Hello, Guest</p>
            <a id="logoutbtn" href="{% url 'login' %}">LOGIN</a>
            {% endif %}
        </div>
    </nav>

    <section class="user-info">
        {% if request.user.is_authenticated %}
        You are a <strong>{{ request.user.get_role_display }}</strong> with Blood Group
        <strong>{{request.user.bgroup}}</strong>
        {% endif %}
    </section>

    {% if request.user.role == "R" %}
    <section class="request-panel">
        <form method="POST" action="{% url 'send_request' %}" class="request-form">
            {% csrf_token %}
            <div class="form-group">
                {{ form.contact.label_tag }}
                {{ form.contact }}
            </div>

            <div class="select-buttons">
                <button type="button" id="autoBtn" class="primary-btn">Auto Select</button>
                <button type="button" id="manualBtn" class="secondary-btn">Manual Select</button><br>
                <div id="notification" style="font-weight:600; color:#2e8b57;"></div>
            </div>

            <div class="submit-buttons">
                <button type="submit" class="primary-btn">Send Request</button>
                <button type="button" id="manualSendBtn" class="secondary-btn">Send Manual Request</button>
            </div>
        </form>
    </section>
    {% endif %}

    <main id="center">
        <div id="map-container">
            <div id="map"></div>
        </div>
    </main>

    <footer id="cfooter">
        <div>
            <p id="quote">
                "The blood you donate gives someone another chance at life. One day that someone may be a
                close relative, a friend, a loved oneâ€”or even you."
            </p>
        </div>

        <div id="donateinfo">
            <p id="label">Want to donate Blood?</p>

            {% if has_filled %}
            <a class="donatebtn disabled-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1" />
                </svg>
                Donate Now
            </a>
            {% else %}
            <a class="donatebtn" href="{% url 'form' %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M4 1c2.21 0 4 1.755 4 3.92C8 2.755 9.79 1 12 1s4 1.755 4 3.92c0 3.263-3.234 4.414-7.608 9.608a.513.513 0 0 1-.784 0C3.234 9.334 0 8.183 0 4.92 0 2.755 1.79 1 4 1" />
                </svg>
                Donate Now
            </a>
            {% endif %}
        </div>
    </footer>

    <div class="popup" id="pop-up">
        {% if messages %}
        {% for message in messages %}
        <span class="popup-message {{ message.tags }}">{{ message }}</span>
        {% endfor %}
        {% endif %}
    </div>

</body>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-boundary-canvas/leaflet-boundary-canvas.js"></script>
<script>
    const popup = document.getElementById("pop-up");

    if (popup && popup.textContent.trim() !== "") {
        viewPopUp();
    }

    function viewPopUp() {
        const popup = document.getElementById("pop-up");
        popup.classList.add("show");

        setTimeout(() => {
            popup.classList.remove("show");
        }, 3000);
    }

    const donors = JSON.parse('{{ donors_json|escapejs }}');
    let manualMode = false;
    let selectedDonors = new Set();
    const markersMap = {};
    const manualSendBtn = document.getElementById("manualSendBtn");
    const manualBtn = document.getElementById("manualBtn")
    const autoBtn = document.getElementById("autoBtn");
    const notificationDiv = document.getElementById("notification");

    const donorIcon = L.icon({
        iconUrl: "{% static 'icon.png' %}",
        iconSize: [40, 40],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30],
    })

    const map = L.map('map', { minZoom: 11, maxZoom: 18, maxBoundsViscosity: 1.0 }).setView([18.95, 73.25], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function addDonor(donorId) {
        selectedDonors.add(donorId);
        console.log("Selected donors:", selectedDonors);
    }

    if (autoBtn) {
        autoBtn.addEventListener("click", () => {
            autoBtn.textContent = "Selected";
            manualMode = false;
            selectedDonors.clear();

            notificationDiv.textContent = `${donors.length} donor/donors have been auto-selected.`;
        });
    }

    fetch("{% static 'area.geojson' %}")
        .then(res => res.json())
        .then(geoJSON => {

            const layer = L.geoJSON(geoJSON, {
                style: { color: 'red', weight: 0.8, fillOpacity: 0 }
            }).addTo(map);

            map.setMaxBounds(layer.getBounds());
            map.panInsideBounds(layer.getBounds());
        })
        .catch(err => console.error(err));

    donors.forEach(donor => {
        let lat = parseFloat(donor.latitude) + (Math.random() - 0.5) * 0.005;
        let lng = parseFloat(donor.longitude) + (Math.random() - 0.5) * 0.005;

        const marker = L.marker([lat, lng], {
            icon: donorIcon
        })

        marker.donorId = donor.id

        marker
            .bindPopup(`User: <b>${donor.full_name}</b><br>
            Blood Group: <b>${donor.bgroup}</b><br>`)
            .addTo(map)
            .on("contextmenu", function () {

                if (!manualMode) return;

                const donorId = this.donorId;

                if (selectedDonors.has(donorId)) {
                    selectedDonors.delete(donorId);
                    this.setOpacity(1)
                } else {
                    selectedDonors.add(donorId);
                    this.setOpacity(0.5)
                }

                notificationDiv.textContent = `${selectedDonors.size} donor/donors have been manually-selected.`;
            })

        L.circle([lat, lng], {
            color: 'red',
            radius: 250
        }).addTo(map);
        markersMap[donor.id] = marker;

    });

    if (manualBtn) {
        manualBtn.addEventListener("click", () => {
            manualMode = true;
            notificationDiv.textContent = `Manual selection mode enabled. Right Click the Donor/Donors on the Map`;
        });
    }

    if (manualSendBtn) {
        manualSendBtn.addEventListener("click", () => {

            if (!manualMode) {
                alert("Enable manual mode first.");
                return;
            }

            if (selectedDonors.size === 0) {
                alert("No donors selected.");
                return;
            }

            const contact = document.querySelector("input[name='contact']").value;

            fetch("{% url 'send_manual_request' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    donor_ids: Array.from(selectedDonors),
                    contact: contact
                })
            })
                .then(res => {
                    if (!res.ok) throw new Error("Server error");
                    return res.json();
                })
                .then(data => {
                    notificationDiv.textContent = `Request sent successfully`;
                    window.location.reload();
                });
        });
    }
</script>

</html>